language: elixir
sudo: required
cache:
  directories:
    - deps
services:
  - docker
  - postgresql
addons:
  postgresql: "9.5"
elixir:
  - 1.4.2
otp_release:
  - 19.3
env:
  global:
    - MIX_ENV=test
    - DOCKER_HUB_ACCOUNT=edenlabllc
    - MAIN_BRANCHES="master develop staging" # Branches on which you want version to be incremented
    - RELEASE_BRANCH="master"
    # Docker and GitHub credentials
    - secure: "U6GUrHzmpX/kRNU5DcD8v/X284rW/tOLfCUYc9JvA7gLU0fiJnCtbECNT2JA7Ty4yZWxMlqjkrF4Z2BH/c9VpbK+fZSD9e0kDhTq7BpblT1D9HSdagc1ngqsc1Ksymu69e8V92Yn0EM4fzxo/tMEBOO3VEZhwxa5wO0SWtleUFY+w83yjAzShiy4EaNpwe5JA5qqfZWBh/G/6+li3NRdkPuKBW4N0ZF4Q1rJkOjNLDsOhNMrYv7Bsnn0ekxvXwKql6iUHn02HyvOK3nB5wHlocUnqNiG4wtV9nbwhAsns3rkodGTniV1KGpOiqDAe/lUSxDSnIDOuHvI/PGvbyfj27aF35RUWmic4v7jOULV8m8pUJmp8kJJEW9lWmhM3gMGEhGnMitf7Uo4X4GgxyEXG2mL8A4bucZp5ZrdCTlvr61KpHERkAWtCQpSHGt+mJW2bTxbdFhaTVUoh3ufblozPAnewffyEDK8FLrFe3bV+4JdE53qcx/D4N36EgHYc/DIHKhydlDKvQ6rwelm+QDP7/DB0AFpWHbB3YHGMsLwA5VyW/wpZWKQJKX7wek15UIGNwwJQjOc7GCfGfb1itTxEYmSOYTKmYEXZDq4MMDeI0IBd8kvUtjXJ++NLzWmfx0TgLqA1xH08RiuvZWoAt6r9k6VOvpjFwBgvCYjp16rf4Y="
    - secure: "i+ddATLtEYSThWtPatl9u8J269kCmq0+ekksflJ+FZH14l4iM1LBxT85XnsXoQVA7sIs3Q2oMJa0msnF/KFLmmnnM23fneqt/2YQi2cz7lFj/SHdDkjLraUkQFdXfW4rcVqVEYtrL7lbH+PBlUxg8MdNMol0Jany1g0Lq9tulJPa/vvb2xHin7cUQruWprollG0qoRJihOX9+kCVtvtzD4fPtuhw319HlpzdmELd6F906+1h0wsVv9MAS3M/Mu1lN+UqjIzXxg1SdCOffU4PLzYwjQG6fDV1xoVr2mV9d+cn+OO7OPzehBjX6EJ3CC7ufTDopnjkJqQ0gIFuhdDWB/ndS0L+gAupzD3yMM01XasTaJUq5Gho+DKvM8SKCt4Ka7KJepvY2fNG27A2ZPJHXxJ0RSXciEvUl79YlIO3oTlku9tuDRqDf8EY/SrZ6LhmwuY+LASaQpviTO2wg+Np+glfp5abKUU4QG1qfzDzNxyTaTdDxwS8lywOP4vqC2Jw3oHyXWwEsz0ZEiFESguzkpj+pi6opzgIOUf7NKKWBujoQxYzE9/E6/VnrjVzBX7GCox87jjmFPA+Zhzu0m86DHWq+mN3nedyzPN6RQ3gkm+KBPQElttcqSFurWzirV54F77l1pvniRlCf3+9Oq/0/FjglraDuk67Eew0v/BWcfs="
branches:
  # Releases are generated automatically, stop infinite build loop
  except:
    - /[0-9]*\.[0-9]*\.[0-9]*/
before_install:
  # Expose MQ and DB to Docker container
  - sudo ./bin/ci/init-db.sh
script:
  # Increment version in mix.exs
  - ./bin/ci/version-increment.sh
  # Install dependencies
  - mix deps.get
  # Run all tests except pending ones
  - mix test --exclude pending --trace
  # Submit code coverage report to Coveralls
  # Add --pro if you using private repo.
  - mix coveralls.travis --exclude pending
  # Run static code analysis
  - mix credo --strict
  # Check code style
  - mix dogma
  # Build Docker container
  - ./bin/build.sh
  # Initialize DB for Docker container
  - MIX_ENV=dev mix ecto.setup
  # Run Docker container
  - sudo ./bin/start.sh
  - sleep 5
  - docker ps
  - RUNNING_CONTAINERS=`docker ps | wc -l`;
    if [ "${RUNNING_CONTAINERS//[[:space:]]/}" == "1" ]; then
      echo "[E] Container is not started\!";
      docker logs uaddresses_api --details --since 5h;
      exit 1;
    fi;
  # Run acceptance tests on Docker container
  - "CONTAINER_HTTP_HOST=localhost CONTAINER_HTTP_PORT=4000 mix test test/acceptance"
after_failure:
  - docker logs uaddresses_api --details --since 5h
after_success:
  # Submit Docker container to Docker Hub and create GitHub Release by pushing tag with changelog
  - ./bin/ci/push.sh
